JENKINS_VM_LAUNCH='local-vm-launch'
NODE_NAME="${JOB_BASE_NAME}-${BUILD_NUMBER}"
NODE_TMPL="docker/ubuntu.m1.medium.yaml"

/* start of bash scripts */
def get_distribution = '''
  mkdir -p tmp/${package}
  dpkg -X ${package} tmp/${package}/
  distribution=$(find tmp/${package}/ -name "changelog.Debian.gz" \
    -exec dpkg-parsechangelog -l {} \\; | awk '/Distribution/ {print $2}')
  echo "Distribution: ${distribution}"
'''
/* end of bash scripts */

vm(NODE_NAME, NODE_TMPL) {
   stage('Setup environment'){

    checkout poll: false,
    scm: [$class: 'GitSCM',
           branches: [[name: "${params.GERRIT_BRANCH}"]],
           extensions: [[$class: 'CleanBeforeCheckout']],
           userRemoteConfigs: [[refspec: "${params.GERRIT_REFSPEC}",
             url: "${params.GERRIT_URL}/${params.GERRIT_PROJECT}" ]]]
   }

  stage('Build package'){

    dir ("${params.GERRIT_PROJECT}") {
      sh "./build.sh"
      sh "ls -l"
    }
  }

  stage('Publish packages'){

    dir ("${params.GERRIT_PROJECT}") {

      sh "ls -l; echo UPLOAD_PACKAGES: ${params.UPLOAD_PACKAGES}"

      // TODO: deb.distribution needs to be derived from package,
      // see get_distribution shell script above. Currently we are 
      // building for xenial only
      if (UPLOAD_PACKAGES == 'true') {
        artf = Artifactory.server 'artifactory'
        uploadSpec = """{"files": [{
                    "pattern": "*.deb",
                    "target": "${params.ARTF_REPOSITORY_PATH}",
                    "props": "deb.distribution=xenial;deb.component=main;deb.architecture=amd64",
                    "flat": "true"
                  }]}"""
        artf.publishBuildInfo(artf.upload(uploadSpec))
      } else {

        echo 'Not uploading packages, as UPLOAD_PACKAGES has noot been enabled'
      }
    }
  }
}
