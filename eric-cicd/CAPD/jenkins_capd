def AIRSHIPCTL
def AIRSHIP_SRC
def KUBECONFIG
def WORKERS_COUNT
def CONTROLPLANE_COUNT
def TEST_SITE
def TARGET_CLUSTER_NAME
def KIND_EXPERIMENTAL_DOCKER_NETWORK
def PROVIDER
node(targetVM) {
	withEnv(['AIRSHIP_SRC=/tmp/airship',
		'KUBECONFIG=$HOME/.airship/kubeconfig',
		'WORKERS_COUNT=2',
		'CONTROLPLANE_COUNT=1',
		'TEST_SITE=docker-test-site',
		'TARGET_CLUSTER_NAME=target-cluster',
		'KIND_EXPERIMENTAL_DOCKER_NETWORK=bridge',
		'AIRSHIPCTL=/tmp/airship/airshipctl',
		'PROVIDER=default' ]){
	try{
		AIRSHIPCTL = sh(script: """echo /tmp/airship/airshipctl""", returnStdout:true).trim()
		stage("Cloning Airshipctl") {
			sh label: '', script: """sudo swapoff -a && \\
			sudo rm -rf ~/.airship && \\
			sudo rm -rf /tmp/airship && \\
			mkdir /tmp/airship && \\
			cd /tmp/airship && \\
			git clone https://opendev.org/airship/airshipctl.git ${AIRSHIPCTL} && \\
			cd $AIRSHIPCTL && \\
			git fetch https://review.opendev.org/airship/airshipctl ${RevisionNum} && git checkout FETCH_HEAD"""
		}
		stage("Setting up Dependencies") {
			sh label: '', script: """ \\
			cd $AIRSHIPCTL &&  ./tools/gate/00_setup.sh && \\
			curl -sSL https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v3.8.5/kustomize_v3.8.5_linux_amd64.tar.gz | tar -C /tmp -xzf - && \\
			sudo install /tmp/kustomize /usr/local/bin && \\
			kustomize version && \\
			sed -i 's/v0.8.1/v0.9.0/g' ./tools/deployment/provider_common/01_install_kind.sh && \\
			sed -i 's/v1.18.6/v1.19.0/g' ./tools/deployment/01_install_kubectl.sh && \\
			./tools/deployment/provider_common/01_install_kind.sh && \\
			./tools/deployment/01_install_kubectl.sh"""
		}
		stage("install Airshipctl") {
			sh label: '', script: """cd $AIRSHIPCTL && sudo -E ./tools/deployment/21_systemwide_executable.sh"""
		}
		stage("CleanUP"){
			sh label: '', script: """kind delete clusters --all"""
		}
		stage("Setting up Ephermal Cluster"){
			writeFile file: 'ephermal.sh', text: '''#!/bin/bash
			cd $AIRSHIPCTL && CLUSTER=ephemeral-cluster KIND_CONFIG=./tools/deployment/templates/kind-cluster-with-extramounts ./tools/document/start_kind.sh'''
			sh 'bash ./ephermal.sh'
		}
		stage("Init AirShip config"){
			writeFile file: 'init.sh', text: '''#!/bin/bash
			cd $AIRSHIPCTL &&  ./tools/deployment/provider_common/03-init-airship-config.sh'''
			sh 'bash ./init.sh'
		}
		stage("Deploy Ephermal"){
			writeFile file: 'epheremal.sh', text: '''#!/bin/bash
			cd $AIRSHIPCTL && PROVIDER=default TEST_SITE=docker-test-site PROVIDER_MANIFEST=docker_manifest ./tools/deployment/26_deploy_capi_ephemeral_node.sh'''
			sh 'bash ./epheremal.sh'
		}
		stage("Deploy Control Plane"){
			writeFile file: 'control-plane.sh', text: '''#!/bin/bash
 			cd $AIRSHIPCTL && CONTROLPLANE_COUNT=1 TEST_SITE=docker-test-site ./tools/deployment/provider_common/30_deploy_controlplane.sh'''
			sh 'bash ./control-plane.sh'
		}
		stage("Cluster Init"){
			writeFile file: 'cluster-init.sh', text: '''#!/bin/bash
			cd $AIRSHIPCTL && KUBECONFIG=/tmp/target-cluster.kubeconfig ./tools/deployment/provider_common/32_cluster_init_target_node.sh'''
			sh 'bash ./cluster-init.sh'
		}
		stage("Cluster Move"){
			sh label: '', script: """cd $AIRSHIPCTL && ./tools/deployment/provider_common/33_cluster_move_target_node.sh"""
		}
		stage("Deploy Worker Node"){
			writeFile file: 'worker-node.sh', text: '''#!/bin/bash
			cd $AIRSHIPCTL && WORKERS_COUNT="2" KUBECONFIG="/tmp/target-cluster.kubeconfig" TEST_SITE="docker-test-site" ./tools/deployment/provider_common/34_deploy_worker_node.sh'''
			sh 'bash ./worker-node.sh'
		}
	}catch (err) {
		echo "Failed: ${err}"
		currentBuild.result = 'FAILURE'
	}
}
}
