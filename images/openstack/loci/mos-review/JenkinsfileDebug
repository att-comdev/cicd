import com.att.nccicd.config.conf as config
import groovy.json.JsonSlurperClassic

conf = new config(env).CONF
RETRY_COUNT = RETRY_COUNT.toInteger()

projectList = new JsonSlurperClassic().parseText(PROJECT_LIST)

if (GERRIT_BRANCH == conf.OCATA_BRANCH) {
    RELEASE = 'ocata'
} else if (GERRIT_BRANCH == conf.STEIN_BRANCH) {
    RELEASE = 'stein'
} else {
    error("Unsupported branch: ${GERRIT_BRANCH}")
}

LABEL = "DebugDeployment-${GERRIT_CHANGE_NUMBER}"

if (nodesByLabel(label: LABEL)) {
    node(label) {
        dir("${WORKSPACE}/../DebugDeploymentPipeline") {
            while (!fileExists("config")) {
                sleep 60
            }
            writeFile(file: "config", text: (System.currentTimeMillis() + 7200000).toString().bytes.encodeBase64().toString())
        }
    }
} else {
    build(job: "${JOB_BASE}/DebugDeploymentPipeline",
          parameters: [
              stringParam(name: 'RELEASE', value: RELEASE),
              stringParam(name: 'LABEL', value: LABEL)
          ],
          wait: false
    )
}
