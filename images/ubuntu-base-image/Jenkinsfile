import com.att.nccicd.config.conf as config
conf = new config(env).CONF

DOCKER_REGISTRY = "${ARTF_SECURE_DOCKER_URL}"
Ubuntu_Repo = "${ARTF_UBUNTU_REPO}"
IMAGE_TAG = "${IMAGETAG}"
VERSION = 1.0

currentBuild.displayName = "#${BUILD_NUMBER} Build on ${BUILD_TIMESTAMP}"

vm2() {
    cleanWs()
    sh ('hostname')
    stage('Setup environment') {
        sh "sudo apt-get update"
        sh "sudo apt-get install -y debootstrap"
    }
    stage('Build') {
        sh "sudo debootstrap --arch=amd64 --variant=minbase ${IMAGE_TAG} ubuntu_${IMAGE_TAG} ${Ubuntu_Repo}"
        sh "sudo tar -C ubuntu_${IMAGE_TAG} -c . | sudo docker import - ubuntu:${IMAGE_TAG}"
        IMAGE = "${DOCKER_REGISTRY}/ubuntu:${IMAGE_TAG}-${BUILD_TIMESTAMP}"
        sh "sudo docker tag ubuntu:${IMAGE_TAG} ${IMAGE}"
    }
    stage('Image Publish') {
        publish.artifactory (IMAGE, "${JOB_BASE_NAME}:${IMAGE_TAG}-${BUILD_TIMESTAMP}")
    }
}
